import numpy as np
import torch
from torch.utils.data import dataset

def make_data(ent_embeddings, des_embeddings, rel_embeddings):
    train_dataset = make_dataset("train2id.txt", ent_embeddings, des_embeddings, rel_embeddings)
    test_dataset = make_dataset("test2id.txt", ent_embeddings, des_embeddings, rel_embeddings)
    valid_dataset = make_dataset("valid2id.txt", ent_embeddings, des_embeddings, rel_embeddings)
    return train_dataset, test_dataset, valid_dataset

def getTrainTriple(triple_dict, train_data_loader):
    for batch_idx, data_batch in enumerate(train_data_loader):
        head, descption, rel, tail, triple_list= data_batch
        for ind in range(len(triple_list)):
            h, t = triple_list[ind][0].item(), triple_list[ind][2].item()
            if h not in triple_dict:
                triple_dict[h] = set()
            triple_dict[h].add(t)
    # print(triple_dict)
    return triple_dict
    
def make_dataset(file_name, ent_embeddings, des_embeddings, rel_embeddings):
    ent_tensors = []
    desp_tensors = []
    rel_tensors = []
    target_tensors = []
    triple_list = []
    f = open(file_name, "r")
    num = int(f.readline())
    if num == 0:
        return
    line = f.readline()
    while line:
        h, t, r = line.split(" ")
        h, t, r = int(h), int(t), int(r)
        # input_tensors.append(np.expand_dims(input_tensor, 0))
        ent_tensors.append(ent_embeddings[h])
        desp_tensors.append(des_embeddings[h])
        target_tensors.append(ent_embeddings[t])
        rel_tensors.append(rel_embeddings[r])
        triple_list.append([h, r, t])
        line = f.readline()

    print(np.shape(ent_tensors))
    print(np.shape(desp_tensors))
    print(np.shape(target_tensors))
    print(np.shape(rel_tensors))

    ent_tensors = torch.FloatTensor(np.array(ent_tensors))
    desp_tensors = torch.FloatTensor(np.array(desp_tensors))
    rel_tensors = torch.FloatTensor(np.array(rel_tensors))
    target_tensors = torch.FloatTensor(np.array(target_tensors))
    triple_list = torch.LongTensor(np.array(triple_list))
    return dataset.TensorDataset(ent_tensors, desp_tensors, rel_tensors, target_tensors, triple_list)

def load_embed(ent_embeddings_file, des_embeddings_file, rel_embeddings_file):
    ent_embeddings = np.loadtxt(ent_embeddings_file)
    des_embeddings = np.loadtxt(des_embeddings_file)
    rel_embeddings = np.loadtxt(rel_embeddings_file)


    # ent_embeddings = (ent_embeddings - np.min(ent_embeddings)) / (np.max(ent_embeddings) - np.min(ent_embeddings))
    # des_embeddings = (des_embeddings - np.min(des_embeddings)) / (np.max(des_embeddings) - np.min(des_embeddings))
    ent_embeddings /= np.linalg.norm(ent_embeddings, axis=1, ord=2, keepdims=True)
    des_embeddings /= np.linalg.norm(des_embeddings, axis=1, ord=2, keepdims=True)
    rel_embeddings /= np.linalg.norm(rel_embeddings, axis=1, ord=2, keepdims=True)

    return ent_embeddings, des_embeddings, rel_embeddings