from xml.dom.minidom import parse
import xml.dom.minidom
import xml.etree.ElementTree as ET

DOMTree = xml.dom.minidom.parse("capec_v3.9.xml")
root = DOMTree.documentElement

attackPatterns = root.getElementsByTagName("Attack_Pattern")
relations = set()
relationsDic = {"CanFollow":0, "CanPrecede":1, "CanAlsoBe":2, "ChildOf":3, "PeerOf":4}
targetRelations = ["CanFollow", "CanPrecede"]
attackPatternDic = {}

relatedAttackPatternNum, targetAttackPatternNum = 0, 0
for attackPattern in attackPatterns:
    ID, name = attackPattern.getAttribute("ID"), attackPattern.getAttribute("Name")
    attackPatternDic[name] = ID
    relatedAttackPatterns = attackPattern.getElementsByTagName("Related_Attack_Pattern")
    for relatedAttackPattern in relatedAttackPatterns:
        relation, relatedAttackPaternID= relatedAttackPattern.getAttribute("Nature"), relatedAttackPattern.getAttribute("CAPEC_ID")
        relatedAttackPatternNum += 1
        if relation in targetRelations:
            targetAttackPatternNum += 1
        relations.add(relation)

print(relations)
relation_f = open("relation2id.txt", "w+")
relation_f.write("%d\n" % len(relationsDic))
ind = 0
for relationName in relationsDic:
    relation_f.write("%s %d\n" %(relationName, relationsDic[relationName]))
    ind += 1
relation_f.close()

entity_f = open("entity2id.txt", "w+")
entity_f.write("%d\n" % len(attackPatternDic))
ind = 0
for entity in attackPatternDic:
    entity_f.write("%s %s\n" %(entity, attackPatternDic[entity]))
    ind += 1
entity_f.close()

train = open("all.txt", "w+")
train.write("%d\n" % targetAttackPatternNum)
for attackPattern in attackPatterns:
    ID, name = attackPattern.getAttribute("ID"), attackPattern.getAttribute("Name")
    relatedAttackPatterns = attackPattern.getElementsByTagName("Related_Attack_Pattern")
    for relatedAttackPattern in relatedAttackPatterns:
        relation, relatedAttackPaternID= relatedAttackPattern.getAttribute("Nature"), relatedAttackPattern.getAttribute("CAPEC_ID")
        if relation in targetRelations:
            relationID = relationsDic[relation]
            if relationID == 0:
                train.write("%s %s %s\n" %(relatedAttackPaternID, ID, 1))
            else:
                train.write("%s %s %s\n" %(ID, relatedAttackPaternID, 1))
train.close()
