from xml.dom.minidom import parse
import xml.dom.minidom
import xml.etree.ElementTree as ET


# # 使用minidom解析器打开 XML 文档
DOMTree = xml.dom.minidom.parse("cwec_v4.10.xml")
root = DOMTree.documentElement

weaknesses = root.getElementsByTagName("Weakness")
relations = set()
relationsDic = {"Requires":0, "CanAlsoBe":1, "StartsWith":2, "ChildOf":3, "CanPrecede":4, "PeerOf":5}
targetRelation = [0, 4]
weaknessName2ID = {}
weaknessID2Ind = {}
weaknessSet = set()

weakNum, relatedWeakNum, targetWeakNum= 0, 0, 0
for weakness in weaknesses:
    ID, name = weakness.getAttribute("ID"), weakness.getAttribute("Name")
    weaknessName2ID[name] = ID
    weaknessID2Ind[ID] = weakNum
    weaknessSet.add(ID)
    weakNum +=1
    relatedWeaknesses = weakness.getElementsByTagName("Related_Weakness")
    for relatedWeakness in relatedWeaknesses:
        relation, relatedWeaknessID= relatedWeakness.getAttribute("Nature"), relatedWeakness.getAttribute("CWE_ID")
        relationID = relationsDic[relation]
        if relationID in targetRelation: 
            targetWeakNum += 1
        relatedWeakNum += 1
        relations.add(relation)

print("There is %d related weakness, and the relations are:" % relatedWeakNum)
print(relations)
relation_f = open("relation2id.txt", "w+")
relation_f.write("%d\n" % len(relationsDic))
ind = 0
for relationName in relationsDic:
    relation_f.write("%s %d\n" %(relationName, relationsDic[relationName]))
    ind += 1
relation_f.close()

entity_f = open("entity2id.txt", "w+")
entity_f.write("%d\n" % len(weaknessName2ID))
ind = 0
for entity in weaknessName2ID:
    entity_f.write("%s %s\n" %(entity, weaknessID2Ind[weaknessName2ID[entity]]))
    ind += 1
entity_f.close()

train = open("all.txt", "w+")
train.write("%d\n" % targetWeakNum)
for weakness in weaknesses:
    ID, name = weakness.getAttribute("ID"), weakness.getAttribute("Name")
    relatedWeaknesses = weakness.getElementsByTagName("Related_Weakness")
    for relatedWeakness in relatedWeaknesses:
        relation, relatedWeaknessID= relatedWeakness.getAttribute("Nature"), relatedWeakness.getAttribute("CWE_ID")
        relationID = relationsDic[relation]
        if relatedWeaknessID not in weaknessSet:
            print("The target related weakness is not in the id set")
        if relationID in targetRelation: 
            train.write("%s %s %d\n" %(weaknessID2Ind[ID], weaknessID2Ind[relatedWeaknessID], relationID))
train.close()
