import numpy as np
import pandas as pd
import json
from xml.dom.minidom import parse
import xml.dom.minidom
import xml.etree.ElementTree as ET


hit = 0
CVE = set()
CWE = set()
CAPEC = set()
Info = set()
Exploitation = {}
capec2cwe = {}
node_id_dict = {}
# columnNames = ["Access Gained", "Attack Origin", "Authentication Required", "Availability", "CVE ID",
#     "CVE Page", "CWE ID", "Complexity", "Confidentiality", "Integrity", "Known Exploits", "Publish Date", 
#     "Score", "Summmary", "Update Date", "Vulnerability Classification", "codeLink"]

CVE_ID = "CVE ID"
CWE_ID = "CWE ID"
CAPEC_ID = "CAPEC ID"
infoName = ["Access Gained", "Attack Origin", "Authentication Required", "Availability",
    "Complexity", "Confidentiality", "Integrity", "Publish Date", "Score", "Update Date",
     "Vulnerability Classification"]

exploitationName = ["cause", "consequence", "version", "location", "attacker", "triggering operation"]

def getStructNodes():
    df = pd.read_csv("../ner/data/all_CVE_details_output.csv")
    for info in infoName:
        hit = 0
        print("processing %s" %info)
        items = df[info].unique()
        for item in items:
            if item == "None":
                continue
            Info.add(item)
            hit += 1
        print("%s num: %d" %(info, hit))

    hit = 0
    cves = df[CVE_ID].unique()
    for cve in cves:
        CVE.add(cve)
        hit += 1
    
    print("CVE num: %d" %hit)

    hit = 0
    cwes = df[CWE_ID].unique()
    for cwe in cwes:
        CWE.add(cwe)
        hit += 1

    print("CWE num: %d" %hit)


def getUnstrtNodes():
    for tagName in exploitationName:
        Exploitation[tagName] = set()
    f = open("../ner/data/ner_result.json", "r")
    line = f.readline()
    while line:
        js = json.loads(line)
        labels = js["label"]
        for tagName in exploitationName:
            tags = labels[tagName]
            for tag in tags:
                Exploitation[tagName].add(tag)
        line = f.readline()
    print("exploitation node num")
    for tagName in exploitationName:
        print(tagName, len(Exploitation[tagName]))

def nodes2ID():
    ind = 1
    f_cve = open("cve.csv", "w",  encoding="utf-8")
    f_cwe = open("cwe.csv", "w",  encoding="utf-8")
    f_inf = open("info.csv", "w",  encoding="utf-8") 
    f_exp = open("exploitation.csv", "w",  encoding="utf-8")
    f_capec = open("capec.csv", "w",  encoding="utf-8")

    f_cve_header = open("cve_header.csv", "w",  encoding="utf-8")
    f_cwe_header = open("cwe_header.csv", "w",  encoding="utf-8")
    f_inf_header = open("info_header.csv", "w",  encoding="utf-8") 
    f_exp_header = open("exploitation_header.csv", "w",  encoding="utf-8") 
    f_capec_header = open("capec_header.csv", "w",  encoding="utf-8")

    f_cve_header.write("CVE-ID:ID,name,:LABEL\n")
    f_cwe_header.write("CWE-ID:ID,name,:LABEL\n")
    f_inf_header.write("InfoID:ID,name,:LABEL\n")
    f_exp_header.write("ExpID:ID,name,:LABEL\n")
    f_capec_header.write("CAPEC_ID:ID,name,:LABEL\n")

    for node in iter(CVE):
        node_id_dict[node] = ind
        f_cve.write("%d,\"%s\",CVE\n" %(ind, node))
        ind+=1
        
    for node in iter(CWE):
        node_id_dict[node] = ind
        f_cwe.write("%d,\"%s\",CWE\n" %(ind, node))
        ind+=1

    for node in iter(Info):
        node_id_dict[node] = ind
        f_inf.write("%d,\"%s\",Info\n" %(ind, node))
        ind+=1

    for key in Exploitation:
        for node in iter(Exploitation[key]):
            node_id_dict[node] = ind
            f_exp.write("%d,\"%s\",Exploitation\n" %(ind, node))
            ind+=1
    
    for node in iter(CAPEC):
        node_id_dict[node] = ind
        f_capec.write("%d,\"%s\",CAPEC\n" %(ind, node))
        ind+=1

    f_cve.close()
    f_cwe.close()
    f_inf.close()
    f_exp.close()
    f_capec.close()

    f_cve_header.close()
    f_cwe_header.close()
    f_inf_header.close()
    f_exp_header.close()
    f_capec_header.close()

def getRelations():
    df = pd.read_csv("../ner/data/all_CVE_details_output.csv")
    f = open("../ner/data/ner_result.json", "r", encoding="utf-8")
    f_info_rel = open("infoRel.csv", "w", encoding="utf-8")
    f_cwe_rel = open("cweRel.csv", "w", encoding="utf-8")
    f_exp_rel = open("expRel.csv", "w", encoding="utf-8")
    f_capec_rel = open("capecRel.csv", "w", encoding="utf-8")

    f_info_rel_header = open("infoRel_header.csv", "w", encoding="utf-8")
    f_cwe_rel_header = open("cweRel_header.csv", "w", encoding="utf-8")
    f_exp_rel_header = open("expRel_header.csv", "w", encoding="utf-8")
    f_capec_rel_header = open("capecRel_header.csv", "w", encoding="utf-8")

    f_info_rel_header.write(":START_ID,name,:END_ID,:TYPE\n")
    f_cwe_rel_header.write(":START_ID,name,:END_ID,:TYPE\n")
    f_exp_rel_header.write(":START_ID,name,:END_ID,:TYPE\n")
    f_capec_rel_header.write(":START_ID,name,:END_ID,:TYPE\n")


    rela_num = {}
    for info in infoName:
        rela_num[info] = 0
    for tag in exploitationName:
        rela_num[tag] = 0

    rela_num["CWE_ID"] = 0
    for _, row in df.iterrows():
        line = f.readline()
        cve = row[CVE_ID]
        cwe = row[CWE_ID]
        cve_ind = node_id_dict[cve]

        if cwe is not np.nan:
            f_cwe_rel.write("%d,CWE_ID,%d,hasCWE\n" %(cve_ind, node_id_dict[cwe]))
            rela_num["CWE_ID"] += 1

        for info in infoName:
            item = row[info]
            if item == "None" or item is np.nan:
                continue
            f_info_rel.write("%d,%s,%d,hasInfo\n" %(cve_ind, info, node_id_dict[item]))
            rela_num[info] += 1

        js = json.loads(line)
        labels = js["label"]
        for tagName in exploitationName:
            tags = labels[tagName]
            for tag in tags:
                f_exp_rel.write("%d,%s,%d,hasExploitation\n" %(cve_ind, tagName, node_id_dict[tag]))
                rela_num[tagName] += 1

    for capec in capec2cwe:
        cwe_set = capec2cwe[capec]
        capecInd = node_id_dict["CAPEC-"+capec]
        for cwe in iter(cwe_set):
            cweInd = node_id_dict["CWE-"+cwe]
            f_capec_rel.write("%d,CAPEC_ID,%d, hasCAPEC\n" %(cweInd, capecInd))

    print("relation num")
    print(rela_num)

    f.close()
    f_info_rel.close()
    f_cwe_rel.close()
    f_exp_rel.close()
    f_capec_rel.close()

    f_info_rel_header.close()
    f_cwe_rel_header.close()
    f_exp_rel_header.close()
    f_capec_rel_header.close()
        
def get_CAPEC_CWE_relations():
    DOMTree = xml.dom.minidom.parse("capec_v3.9.xml")
    root = DOMTree.documentElement
    capecs = root.getElementsByTagName("Attack_Pattern")
    # print(root)x
    for capec in capecs:
        CAPEC_ID, name = capec.getAttribute("ID"), capec.getAttribute("Name")
        CAPEC.add("CAPEC-"+CAPEC_ID)
        capec2cwe[CAPEC_ID] = set()
        related_weaknesses = capec.getElementsByTagName("Related_Weakness")
        for related_weakness in related_weaknesses:
            CWE_ID = related_weakness.getAttribute("CWE_ID")
            CWE.add("CWE-"+CWE_ID)
            capec2cwe[CAPEC_ID].add(CWE_ID)
    # print(capec2cwe)

def main():
    get_CAPEC_CWE_relations()
    getStructNodes()
    getUnstrtNodes()
    nodes2ID()
    getRelations()

if __name__ == "__main__":
    main()

